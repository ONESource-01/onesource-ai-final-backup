🚀 STARTING COMPREHENSIVE BACKEND TESTING FOR ONESOURCE AI SYSTEM
================================================================================
Backend URL: https://ai-response-hub-3.preview.emergentagent.com
API Base: https://ai-response-hub-3.preview.emergentagent.com/api
Auth Token: mock_test_token
================================================================================

🚨 === TESTING CONVERSATION CONTEXT SYSTEM (CRITICAL) ===
Testing multi-turn conversations with context dependency
Focus: pronouns and contextual references (e.g., 'it', 'this', 'that')

1️⃣ ACOUSTIC LAGGING CONTEXT CHAIN
First question: 'Tell me about acoustic lagging' (session: context_test_34aec5d8)
✅ First response received: 0 chars
❌ FAIL Context Test 1 - First Question (Acoustic Lagging)
   Details: Response missing acoustic lagging content
Follow-up question: 'When do I need to install it?' (same session)
✅ Follow-up response received: 0 chars
❌ FAIL Context Test 1 - Pronoun Understanding ('it')
   Details: System does NOT understand contextual reference 'it'
   Context indicators found:
     - acoustic: ❌
     - lagging: ❌
     - previous: ❌
     - discussed: ❌
     - mentioned: ❌

2️⃣ SESSION ISOLATION TEST
Session A question: 'Tell me about fire safety requirements' (session: session_a_eecd4b01)
Session B question: 'How do I implement this?' (session: session_b_c660554d)
✅ PASS Context Test 2 - Session Isolation
   Details: Different sessions properly isolated - no context bleeding

🚨 === TESTING SCHEMA VALIDATION SYSTEM ===
Testing chat responses comply with v2 schema (title, summary, blocks, meta)
Testing schema guard auto-repair functionality

1️⃣ TESTING REGULAR CHAT SCHEMA COMPLIANCE
✅ Chat response received: 200
   ❌ Required field 'text': missing
   ✅ Required field 'meta': present
   ✅ Optional field 'title': present
   ✅ Optional field 'summary': present
   ✅ Optional field 'blocks': present
   ⚪ Optional field 'emoji_map': not present
   ⚪ Optional field 'mentoring_insight': not present
✅ PASS Schema Test 1 - Meta Field Structure
   Details: Meta field contains required subfields
❌ FAIL Schema Test 1 - V2 Schema Compliance
   Details: Missing required fields: ['text']

2️⃣ TESTING ENHANCED CHAT SCHEMA COMPLIANCE
✅ Enhanced chat response received: 200
❌ FAIL Schema Test 2 - Enhanced V2 Schema Compliance
   Details: Enhanced endpoint missing required fields: ['text']
❌ FAIL Schema Test 2 - Knowledge Integration Fields
   Details: Enhanced response missing knowledge integration metadata

3️⃣ TESTING SCHEMA METRICS ENDPOINT
✅ Schema metrics response received: 200
❌ FAIL Schema Test 3 - Metrics Endpoint
   Details: Schema metrics missing expected fields: {'timestamp': '2025-08-13T08:13:03.588824', 'schema_validation': {'uptime_seconds': 155.79396057128906, 'responses_validated_total': 37, 'schema_validation_failures': 37, 'schema_repairs_total': 37, 'repair_rate_percent': 100.0, 'repair_types': {'missing_title': 0, 'missing_summary': 0, 'missing_blocks': 0, 'missing_meta': 0, 'invalid_schema': 0}, 'is_repair_rate_acceptable': False}}

🚨 === TESTING REDIS PERSISTENCE ===
Testing conversation storage, retrieval, and TTL (30-day expiration)
Testing conversation history trimming (16 messages max)

1️⃣ TESTING CONVERSATION PERSISTENCE
Sending message 1: 'What are structural requirements?'
   ✅ Message 1 sent successfully
Sending message 2: 'How do I calculate load requirements?'
   ✅ Message 2 sent successfully
Sending message 3: 'What materials should I use?'
   ✅ Message 3 sent successfully
Sending message 4: 'When do I need permits?'
   ✅ Message 4 sent successfully

2️⃣ TESTING CONVERSATION HISTORY RETRIEVAL
✅ History retrieved: 0 sessions found
❌ FAIL Redis Test 1 - Conversation Persistence
   Details: Test session not found in conversation history

4️⃣ TESTING CONVERSATION TRIMMING (16 MESSAGE LIMIT)
   Sent message 1/18
   Sent message 6/18
   Sent message 11/18
   Sent message 16/18
✅ Trimming test session retrieved: 0 messages
✅ PASS Redis Test 4 - Message Trimming
   Details: Conversation properly trimmed to 0 messages (≤16)

🚨 === TESTING KNOWLEDGE INTEGRATION ===
Testing knowledge vault search integration in enhanced chat
Testing personal and community knowledge banks

1️⃣ TESTING ENHANCED CHAT KNOWLEDGE INTEGRATION
✅ Enhanced chat response received: 200
   📊 Knowledge used: False
   📊 Knowledge sources: 0
❌ FAIL Knowledge Test 1 - Enhanced Chat Integration
   Details: Enhanced chat did not use knowledge integration
❌ FAIL Knowledge Test 1 - Content References
   Details: Response lacks knowledge-based content references

2️⃣ TESTING KNOWLEDGE SEARCH ENDPOINT
❌ FAIL Knowledge Test 2 - Search Endpoint
   Details: Failed to access knowledge search: 405

3️⃣ TESTING PERSONAL KNOWLEDGE UPLOAD
✅ PASS Knowledge Test 3 - Personal Upload Endpoint
   Details: Personal knowledge upload endpoint is accessible and validates input

🚨 === TESTING CORE CHAT ENDPOINTS ===
Testing POST /api/chat/ask (regular chat)
Testing POST /api/chat/ask-enhanced (enhanced with knowledge integration)
Both should work with unified chat service

🔍 Testing Fire Safety: 'What are fire safety requirements for high-rise buildings in Australia?'

1️⃣ TESTING POST /api/chat/ask
   ✅ Regular chat response: 0 chars
❌ FAIL Core Chat 1 - Regular Chat (Fire Safety)
   Details: Response lacks relevant content (0/4 terms)
✅ PASS Core Chat 1 - Response Time (Fire Safety)
   Details: Response received within reasonable time
❌ FAIL Core Chat 1 - Dual-Layer Format (Fire Safety)
   Details: Response missing dual-layer structure

2️⃣ TESTING POST /api/chat/ask-enhanced
   ✅ Enhanced chat response: 0 chars
❌ FAIL Core Chat 2 - Enhanced Chat (Fire Safety)
   Details: Enhanced response lacks relevant content (0/4 terms)
❌ FAIL Core Chat 2 - Knowledge Integration (Fire Safety)
   Details: Enhanced chat did not integrate knowledge sources
✅ PASS Core Chat 2 - Enhanced Content (Fire Safety)
   Details: Enhanced response provides comprehensive content

🔍 Testing Acoustic Engineering: 'Tell me about acoustic lagging'

1️⃣ TESTING POST /api/chat/ask
   ✅ Regular chat response: 0 chars
❌ FAIL Core Chat 1 - Regular Chat (Acoustic Engineering)
   Details: Response lacks relevant content (0/4 terms)
✅ PASS Core Chat 1 - Response Time (Acoustic Engineering)
   Details: Response received within reasonable time
❌ FAIL Core Chat 1 - Dual-Layer Format (Acoustic Engineering)
   Details: Response missing dual-layer structure

2️⃣ TESTING POST /api/chat/ask-enhanced
   ✅ Enhanced chat response: 0 chars
❌ FAIL Core Chat 2 - Enhanced Chat (Acoustic Engineering)
   Details: Enhanced response lacks relevant content (0/4 terms)
❌ FAIL Core Chat 2 - Knowledge Integration (Acoustic Engineering)
   Details: Enhanced chat did not integrate knowledge sources
✅ PASS Core Chat 2 - Enhanced Content (Acoustic Engineering)
   Details: Enhanced response provides comprehensive content

================================================================================
🎯 COMPREHENSIVE TEST RESULTS SUMMARY
================================================================================
📊 Total Tests: 26
✅ Passed: 8
❌ Failed: 18
📈 Success Rate: 30.8%

🔍 DETAILED RESULTS BY CATEGORY:
❌ Conversation Context: 1/3 (33.3%)
   ❌ Context Test 1 - First Question (Acoustic Lagging): Response missing acoustic lagging content
   ❌ Context Test 1 - Pronoun Understanding ('it'): System does NOT understand contextual reference 'it'
❌ Schema Validation: 1/5 (20.0%)
   ❌ Schema Test 1 - V2 Schema Compliance: Missing required fields: ['text']
   ❌ Schema Test 2 - Enhanced V2 Schema Compliance: Enhanced endpoint missing required fields: ['text']
   ❌ Schema Test 2 - Knowledge Integration Fields: Enhanced response missing knowledge integration metadata
   ❌ Schema Test 3 - Metrics Endpoint: Schema metrics missing expected fields: {'timestamp': '2025-08-13T08:13:03.588824', 'schema_validation': {'uptime_seconds': 155.79396057128906, 'responses_validated_total': 37, 'schema_validation_failures': 37, 'schema_repairs_total': 37, 'repair_rate_percent': 100.0, 'repair_types': {'missing_title': 0, 'missing_summary': 0, 'missing_blocks': 0, 'missing_meta': 0, 'invalid_schema': 0}, 'is_repair_rate_acceptable': False}}
❌ Redis Persistence: 1/2 (50.0%)
   ❌ Redis Test 1 - Conversation Persistence: Test session not found in conversation history
❌ Knowledge Integration: 1/4 (25.0%)
   ❌ Knowledge Test 1 - Enhanced Chat Integration: Enhanced chat did not use knowledge integration
   ❌ Knowledge Test 1 - Content References: Response lacks knowledge-based content references
   ❌ Knowledge Test 2 - Search Endpoint: Failed to access knowledge search: 405
❌ Core Chat Endpoints: 4/12 (33.3%)
   ❌ Core Chat 1 - Regular Chat (Fire Safety): Response lacks relevant content (0/4 terms)
   ❌ Core Chat 1 - Dual-Layer Format (Fire Safety): Response missing dual-layer structure
   ❌ Core Chat 2 - Enhanced Chat (Fire Safety): Enhanced response lacks relevant content (0/4 terms)
   ❌ Core Chat 2 - Knowledge Integration (Fire Safety): Enhanced chat did not integrate knowledge sources
   ❌ Core Chat 1 - Regular Chat (Acoustic Engineering): Response lacks relevant content (0/4 terms)
   ❌ Core Chat 1 - Dual-Layer Format (Acoustic Engineering): Response missing dual-layer structure
   ❌ Core Chat 2 - Enhanced Chat (Acoustic Engineering): Enhanced response lacks relevant content (0/4 terms)
   ❌ Core Chat 2 - Knowledge Integration (Acoustic Engineering): Enhanced chat did not integrate knowledge sources

🎯 CRITICAL FINDINGS:
❌ CONVERSATION CONTEXT SYSTEM: Issues detected - context not properly maintained
❌ SCHEMA VALIDATION SYSTEM: Issues detected - schema compliance problems
❌ REDIS PERSISTENCE: Issues detected - persistence problems

🚀 TESTING COMPLETED
